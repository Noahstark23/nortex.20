// ESTO VA EN: /backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. EL INQUILINO (La PyME)
model Tenant {
  id            String    @id @default(uuid())
  name          String
  type          String    // 'FERRETERIA', 'FARMACIA'
  slug          String    @unique // subdominio
  plan          String    @default("FREE")

  // Fintech Core
  walletBalance Decimal   @default(0.00)
  creditScore   Int       @default(0)
  creditLimit   Decimal   @default(0.00)

  users         User[]
  products      Product[]
  sales         Sale[]
  transactions  Transaction[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([slug])
}

// 2. USUARIOS (Seguridad)
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          String    // 'OWNER', 'CASHIER'

  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  sales         Sale[]

  createdAt     DateTime  @default(now())
}

// 3. INVENTARIO (Activos)
model Product {
  id            String    @id @default(uuid())
  sku           String
  name          String
  price         Decimal
  cost          Decimal
  stock         Int       @default(0)

  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  saleItems     SaleItem[]

  @@unique([tenantId, sku]) // El SKU es único por tienda, no global
}

// 4. VENTAS (El motor del Scoring)
model Sale {
  id            String     @id @default(uuid())
  total         Decimal
  status        String     @default("COMPLETED") // 'COMPLETED', 'REFUNDED'
  paymentMethod String     // 'CASH', 'CARD', 'QR'

  tenantId      String
  tenant        Tenant     @relation(fields: [tenantId], references: [id])

  userId        String
  user          User       @relation(fields: [userId], references: [id])

  items         SaleItem[]

  createdAt     DateTime   @default(now())

  @@index([tenantId, createdAt])
}

model SaleItem {
  id            String   @id @default(uuid())
  saleId        String
  sale          Sale     @relation(fields: [saleId], references: [id])

  productId     String
  product       Product  @relation(fields: [productId], references: [id])

  quantity      Int
  priceAtSale   Decimal
}

// 5. AUDITORÍA FINANCIERA (Inmutable)
model Transaction {
  id            String   @id @default(uuid())
  amount        Decimal
  type          String   // 'SALE_INCOME', 'LOAN_DISBURSEMENT', 'WITHDRAWAL'

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  referenceId   String?  // ID de la Venta o del Préstamo
  balanceAfter  Decimal

  createdAt     DateTime @default(now())
}
