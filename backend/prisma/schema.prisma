// NORTEX INC. - REAL MONEY PROTOCOL SCHEMA
// Expense & B2BOrder models for Real Business Logic

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// CORE BUSINESS ENTITIES
// ==========================================

model Tenant {
  id                   String    @id @default(cuid())
  businessName         String
  taxId                String    @unique
  walletBalance        Decimal   @default(0) @db.Decimal(12, 2)
  creditLimit          Decimal   @default(0) @db.Decimal(12, 2)
  creditScore          Int       @default(0)
  subscriptionStatus   String    @default("TRIAL") // TRIAL | ACTIVE | PAST_DUE | CANCELLED
  stripeCustomerId     String? // Stripe Customer ID (cus_xxx)
  stripeSubscriptionId String? // Stripe Subscription ID (sub_xxx)
  subscriptionEndsAt   DateTime? // Fecha de vencimiento de la suscripci√≥n
  theftAlertThreshold  Decimal   @default(500) @db.Decimal(10, 2) // Umbral de alerta "Robo Hormiga" (NIO)
  createdAt            DateTime  @default(now())

  users           User[]
  customers       Customer[]
  suppliers       Supplier[]
  employees       Employee[]
  sales           Sale[]
  shifts          Shift[]
  auditLogs       AuditLog[]
  expenses        Expense[]
  b2bOrders       B2BOrder[]
  products        Product[]
  kardexMovements KardexMovement[]
  purchases       Purchase[]
  manualPayments  ManualPayment[]
  quotations      Quotation[]
  invitations     Invitation[]
  cashMovements   CashMovement[]
}

model User {
  id        String    @id @default(cuid())
  tenantId  String
  email     String    @unique
  password  String
  name      String
  role      String    @default("EMPLOYEE") // OWNER, ADMIN, MANAGER, CASHIER, VIEWER
  status    String    @default("ACTIVE") // ACTIVE, DISABLED
  lastLogin DateTime?
  invitedBy String?
  createdAt DateTime  @default(now())

  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  shifts          Shift[]
  payments        Payment[]
  auditLogs       AuditLog[]
  productsCreated Product[]
  kardexMovements KardexMovement[]
  passwordResets  PasswordReset[]
  cashMovements   CashMovement[]

  @@index([tenantId])
}

// ==========================================
// INVITACIONES DE EQUIPO
// ==========================================

model Invitation {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  role      String   // MANAGER, CASHIER, VIEWER
  token     String   @unique
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  invitedBy String   // userId del que invit√≥
  createdAt DateTime @default(now())
  expiresAt DateTime // 48 horas despu√©s de creaci√≥n

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([token])
}

// ==========================================
// RECUPERACI√ìN DE CONTRASE√ëA
// ==========================================

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([token])
}

model Customer {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  taxId       String?
  phone       String?
  email       String?
  address     String?  @db.Text
  creditLimit Decimal  @default(0) @db.Decimal(10, 2)
  currentDebt Decimal  @default(0) @db.Decimal(10, 2)
  isBlocked   Boolean  @default(false)
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  sales  Sale[]

  @@index([tenantId])
}

model Supplier {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  contactName String?
  phone       String?
  email       String?
  category    String?
  createdAt   DateTime @default(now())

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  purchases Purchase[]

  @@index([tenantId])
}

// ==========================================
// COMPRAS & CUENTAS POR PAGAR
// ==========================================

model Purchase {
  id            String    @id @default(cuid())
  tenantId      String
  supplierId    String
  invoiceNumber String // # Factura del proveedor
  date          DateTime  @default(now())
  dueDate       DateTime? // Fecha de vencimiento (para cr√©dito)
  subtotal      Decimal   @db.Decimal(12, 2)
  tax           Decimal   @default(0) @db.Decimal(12, 2)
  total         Decimal   @db.Decimal(12, 2)
  status        String    @default("COMPLETED") // COMPLETED | PENDING_PAYMENT
  paymentMethod String // CASH | CREDIT
  notes         String?   @db.Text
  createdBy     String
  createdAt     DateTime  @default(now())

  tenant   Tenant         @relation(fields: [tenantId], references: [id])
  supplier Supplier       @relation(fields: [supplierId], references: [id])
  items    PurchaseItem[]

  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
}

model PurchaseItem {
  id          String  @id @default(cuid())
  purchaseId  String
  productId   String
  productName String // Snapshot del nombre al momento de compra
  quantity    Int
  unitCost    Decimal @db.Decimal(10, 2)
  totalCost   Decimal @db.Decimal(10, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
}

model Employee {
  id                    String   @id @default(cuid())
  tenantId              String
  firstName             String
  lastName              String
  role                  String
  pin                   String   @default("0000")
  cedula                String? // C√©dula de identidad nicarag√ºense
  inss                  String? // N√∫mero INSS del empleado
  baseSalary            Decimal  @db.Decimal(10, 2)
  commissionRate        Decimal  @default(0) @db.Decimal(5, 2)
  phone                 String?
  vacationDays          Float    @default(0) // D√≠as de vacaciones acumulados
  accumulatedThirteenth Decimal  @default(0) @db.Decimal(10, 2) // Aguinaldo acumulado
  hireDate              DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  sales    Sale[]
  shifts   Shift[]
  payrolls Payroll[]

  @@index([tenantId])
}

// ==========================================
// N√ìMINA NICARAG√úENSE (LEY 185 C√ìDIGO DEL TRABAJO)
// ==========================================

model Payroll {
  id         String @id @default(cuid())
  tenantId   String
  employeeId String
  month      Int // 1-12
  year       Int

  // Ingresos
  grossSalary Decimal @db.Decimal(10, 2) // Salario Base
  commissions Decimal @default(0) @db.Decimal(10, 2)
  totalIncome Decimal @db.Decimal(10, 2) // Bruto total

  // Deducciones de Ley
  inssLaboral     Decimal @db.Decimal(10, 2) // 7% (INSS Laboral)
  irLaboral       Decimal @db.Decimal(10, 2) // IR seg√∫n tabla progresiva DGI
  totalDeductions Decimal @db.Decimal(10, 2)

  // Neto
  netSalary Decimal @db.Decimal(10, 2) // Neto a recibir

  // Aportes Patronales (costo empresa)
  inssPatronal Decimal @db.Decimal(10, 2) // 22.5% (INSS Patronal)
  inatec       Decimal @db.Decimal(10, 2) // 2% (INATEC)

  status    String    @default("PENDIENTE") // PENDIENTE | PAGADO
  paidAt    DateTime?
  createdAt DateTime  @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([tenantId])
  @@index([employeeId])
}

// ==========================================
// REPORTES FISCALES DGI NICARAGUA
// ==========================================

model TaxReport {
  id       String @id @default(cuid())
  tenantId String
  month    Int
  year     Int

  // Ventas
  totalSales        Decimal @db.Decimal(12, 2)
  totalIVACollected Decimal @db.Decimal(12, 2) // IVA cobrado en ventas
  totalIVAPaid      Decimal @db.Decimal(12, 2) // IVA pagado en compras (cr√©dito fiscal)

  // Impuestos a pagar
  ivaNeto     Decimal @db.Decimal(12, 2) // IVA Ventas - IVA Compras
  anticipoIR  Decimal @db.Decimal(12, 2) // 1% sobre ventas netas
  imiAlcaldia Decimal @db.Decimal(12, 2) // 1% impuesto municipal
  totalToPay  Decimal @db.Decimal(12, 2)

  generatedAt DateTime @default(now())

  @@unique([tenantId, month, year])
  @@index([tenantId])
}

model Sale {
  id            String    @id @default(cuid())
  tenantId      String
  total         Decimal   @db.Decimal(10, 2)
  status        String
  paymentMethod String
  customerName  String?
  customerId    String?
  employeeId    String?
  balance       Decimal   @default(0) @db.Decimal(10, 2)
  dueDate       DateTime?
  shiftId       String?
  createdAt     DateTime  @default(now())

  tenant   Tenant     @relation(fields: [tenantId], references: [id])
  customer Customer?  @relation(fields: [customerId], references: [id])
  employee Employee?  @relation(fields: [employeeId], references: [id])
  shift    Shift?     @relation(fields: [shiftId], references: [id])
  items    SaleItem[]
  payments Payment[]

  @@index([tenantId])
  @@index([customerId])
  @@index([employeeId])
  @@index([shiftId])
}

model SaleItem {
  id          String  @id @default(cuid())
  saleId      String
  productId   String
  quantity    Int
  priceAtSale Decimal @db.Decimal(10, 2)
  costAtSale  Decimal @db.Decimal(10, 2)

  sale Sale @relation(fields: [saleId], references: [id])

  @@index([saleId])
}

model Payment {
  id          String   @id @default(cuid())
  saleId      String
  amount      Decimal  @db.Decimal(10, 2)
  method      String
  collectedBy String
  createdAt   DateTime @default(now())

  sale Sale @relation(fields: [saleId], references: [id])
  user User @relation(fields: [collectedBy], references: [id])

  @@index([saleId])
}

model Shift {
  id                 String    @id @default(cuid())
  tenantId           String
  userId             String
  employeeId         String? // Empleado que abri√≥ la caja (PIN)
  initialCash        Decimal   @db.Decimal(10, 2)
  finalCashDeclared  Decimal?  @db.Decimal(10, 2)
  systemExpectedCash Decimal?  @db.Decimal(10, 2)
  difference         Decimal?  @db.Decimal(10, 2)
  status             String
  startTime          DateTime  @default(now())
  endTime            DateTime?

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  employee      Employee?      @relation(fields: [employeeId], references: [id])
  sales         Sale[]
  cashMovements CashMovement[]

  @@index([tenantId])
  @@index([userId])
  @@index([employeeId])
}

model Expense {
  id          String   @id @default(cuid())
  tenantId    String
  amount      Decimal  @db.Decimal(12, 2)
  description String   @db.Text
  category    String
  createdAt   DateTime @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  cashMovement CashMovement?

  @@index([tenantId])
  @@index([category])
}

// ==========================================
// üí∞ CASH MOVEMENTS (ENTRADAS/SALIDAS DE CAJA)
// ==========================================

model CashMovement {
  id          String    @id @default(cuid())
  tenantId    String
  shiftId     String
  userId      String
  type        String    // IN | OUT
  amount      Decimal   @db.Decimal(10, 2)
  currency    String    @default("NIO") // NIO | USD
  category    String    // GASTO_OPERATIVO | PAGO_PROVEEDOR | RETIRO_PERSONAL | CAMBIO | INYECCION_CAPITAL | AJUSTE
  description String    @db.Text
  expenseId   String?   @unique // Auto-linked Expense (for OUT movements)
  isVoided    Boolean   @default(false) // Soft delete: movimiento anulado
  voidReason  String?   @db.Text
  voidedAt    DateTime?
  voidedBy    String?
  createdAt   DateTime  @default(now())

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  shift   Shift    @relation(fields: [shiftId], references: [id])
  user    User     @relation(fields: [userId], references: [id])
  expense Expense? @relation(fields: [expenseId], references: [id])

  @@index([tenantId])
  @@index([shiftId])
  @@index([createdAt])
}

model B2BOrder {
  id        String   @id @default(cuid())
  tenantId  String
  total     Decimal  @db.Decimal(12, 2)
  items     Json
  status    String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  action    String
  details   String?  @db.Text
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
}

// ==========================================
// INVENTORY MANAGEMENT (Professional Kardex System)
// ==========================================

model Product {
  id       String @id @default(cuid())
  tenantId String

  // Identificaci√≥n
  name        String
  sku         String // C√≥digo √∫nico del producto
  description String? @db.Text
  category    String?

  // Precios
  price Float // Precio de venta
  cost  Float // Costo de compra

  // Inventario
  stock    Int    @default(0)
  minStock Int    @default(0) // Stock m√≠nimo para alerta
  unit     String @default("unidad") // kg, litro, unidad, caja, etc.

  // Auditor√≠a
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relaciones
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator         User             @relation(fields: [createdBy], references: [id])
  kardexMovements KardexMovement[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([category])
}

model KardexMovement {
  id       String @id @default(cuid())
  tenantId String

  // Producto afectado
  productId String

  // Tipo de movimiento
  type     String // IN (entrada), OUT (salida), SALE (venta), ADJUSTMENT (ajuste), RETURN (devoluci√≥n)
  quantity Int // Cantidad (positiva para entradas, negativa para salidas)

  // Stock antes/despu√©s para auditor√≠a
  stockBefore Int
  stockAfter  Int

  // Referencia opcional (ID de venta, compra, etc.)
  referenceId   String?
  referenceType String? // SALE, PURCHASE, ADJUSTMENT, INITIAL

  // Auditor√≠a
  reason String?  @db.Text
  date   DateTime @default(now())
  userId String

  // Relaciones
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([tenantId])
  @@index([date])
  @@index([type])
}

// ==========================================
// PAGOS MANUALES (DEP√ìSITO / TRANSFERENCIA)
// ==========================================

model ManualPayment {
  id              String    @id @default(cuid())
  tenantId        String
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD") // USD | NIO
  bank            String // Banco destino (BAC, Lafise, etc.)
  referenceNumber String // N√∫mero de referencia del voucher
  proofUrl        String?   @db.Text // URL/ruta de la foto del comprobante
  notes           String?   @db.Text
  status          String    @default("PENDING") // PENDING | APPROVED | REJECTED
  rejectionReason String?   @db.Text
  reviewedBy      String? // userId del admin que revis√≥
  reviewedAt      DateTime?
  createdAt       DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
}

// ==========================================
// QUOTATIONS (COTIZACIONES)
// ==========================================

model Quotation {
  id           String   @id @default(cuid())
  tenantId     String
  customerName String
  customerRuc  String?
  subtotal     Decimal  @db.Decimal(10, 2)
  tax          Decimal  @db.Decimal(10, 2)
  total        Decimal  @db.Decimal(10, 2)
  status       String   @default("SENT") // SENT | CONVERTED | EXPIRED
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  tenant Tenant          @relation(fields: [tenantId], references: [id])
  items  QuotationItem[]

  @@index([tenantId])
}

model QuotationItem {
  id          String  @id @default(cuid())
  quotationId String
  productId   String
  quantity    Int
  price       Decimal @db.Decimal(10, 2)
  name        String // Snapshot name

  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
}
